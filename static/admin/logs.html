<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Logs - SEO Autopilot Admin</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Job Logs Page Specific Styles */
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
        }

        .page-header {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            padding: 24px 32px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .page-header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-title {
            color: #fff;
            font-size: 24px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .page-title .icon {
            font-size: 28px;
        }

        .nav-links {
            display: flex;
            gap: 16px;
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .nav-link:hover,
        .nav-link.active {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 32px;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
        }

        .stat-label {
            color: rgba(255, 255, 255, 0.6);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #fff;
        }

        .stat-card.success .stat-value {
            color: #4ade80;
        }

        .stat-card.failed .stat-value {
            color: #f87171;
        }

        .stat-card.warning .stat-value {
            color: #fbbf24;
        }

        .stat-card.info .stat-value {
            color: #60a5fa;
        }

        /* Filters Section */
        .filters-section {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .filters-row {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            align-items: flex-end;
        }

        .filter-group {
            flex: 1;
            min-width: 150px;
        }

        .filter-label {
            display: block;
            color: rgba(255, 255, 255, 0.7);
            font-size: 13px;
            margin-bottom: 8px;
        }

        .filter-input,
        .filter-select {
            width: 100%;
            padding: 10px 14px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
        }

        .filter-select option {
            background: #1a1a2e;
            color: #fff;
        }

        .filter-input:focus,
        .filter-select:focus {
            outline: none;
            border-color: #60a5fa;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
        }

        .btn-filter {
            padding: 10px 24px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-filter:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-refresh {
            padding: 10px 24px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-refresh:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* Logs Table */
        .logs-table-container {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logs-table {
            width: 100%;
            border-collapse: collapse;
        }

        .logs-table thead {
            background: rgba(0, 0, 0, 0.3);
        }

        .logs-table th {
            padding: 16px 20px;
            text-align: left;
            color: rgba(255, 255, 255, 0.7);
            font-weight: 500;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .logs-table tbody tr {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: background 0.2s;
        }

        .logs-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .logs-table td {
            padding: 16px 20px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
        }

        /* Status Badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-success {
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
        }

        .status-failed {
            background: rgba(248, 113, 113, 0.2);
            color: #f87171;
        }

        .status-running {
            background: rgba(96, 165, 250, 0.2);
            color: #60a5fa;
        }

        .status-timeout {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .status-rate_limited {
            background: rgba(251, 146, 60, 0.2);
            color: #fb923c;
        }

        .status-pending {
            background: rgba(156, 163, 175, 0.2);
            color: #9ca3af;
        }

        .status-cancelled {
            background: rgba(156, 163, 175, 0.2);
            color: #9ca3af;
        }

        .job-type-badge {
            background: rgba(139, 92, 246, 0.2);
            color: #a78bfa;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
        }

        .duration-cell {
            font-family: 'SF Mono', Monaco, monospace;
            color: rgba(255, 255, 255, 0.7);
        }

        .error-indicator {
            color: #f87171;
            cursor: pointer;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            background: rgba(0, 0, 0, 0.2);
        }

        .pagination-info {
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
        }

        .pagination-controls {
            display: flex;
            gap: 8px;
        }

        .page-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            transition: all 0.2s;
        }

        .page-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.2);
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: transparent;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #1e1e30, #252541);
            border-radius: 20px;
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            padding: 24px;
            background: rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-title {
            color: #fff;
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 28px;
            cursor: pointer;
            line-height: 1;
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: #fff;
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            max-height: calc(85vh - 80px);
        }

        .detail-section {
            margin-bottom: 24px;
        }

        .detail-section-title {
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .detail-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px 16px;
            border-radius: 8px;
        }

        .detail-label {
            color: rgba(255, 255, 255, 0.5);
            font-size: 12px;
            margin-bottom: 4px;
        }

        .detail-value {
            color: #fff;
            font-size: 14px;
        }

        .code-block {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 8px;
            padding: 16px;
            overflow-x: auto;
        }

        .code-block pre {
            color: #e2e8f0;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 13px;
            line-height: 1.6;
            margin: 0;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .error-block {
            background: rgba(248, 113, 113, 0.1);
            border: 1px solid rgba(248, 113, 113, 0.3);
            border-radius: 8px;
            padding: 16px;
        }

        .error-block pre {
            color: #fca5a5;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 13px;
            line-height: 1.6;
            margin: 0;
            white-space: pre-wrap;
        }

        /* Loading */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            align-items: center;
            justify-content: center;
        }

        .loading-overlay.show {
            display: flex;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: #60a5fa;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: rgba(255, 255, 255, 0.5);
        }

        .empty-state .icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .page-header-content {
                flex-direction: column;
                gap: 16px;
            }

            .filters-row {
                flex-direction: column;
            }

            .logs-table {
                display: block;
                overflow-x: auto;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>

<body>
    <!-- Page Header -->
    <header class="page-header">
        <div class="page-header-content">
            <h1 class="page-title">
                <span class="icon">üìã</span>
                Job Execution Logs
            </h1>
            <nav class="nav-links">
                <a href="index.html" class="nav-link">‚öôÔ∏è Config</a>
                <a href="opportunities.html" class="nav-link">üéØ Opportunities</a>
                <a href="logs.html" class="nav-link active">üìã Logs</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-container">
        <!-- Stats Cards -->
        <section class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-label">Total Jobs</div>
                <div class="stat-value" id="statTotal">-</div>
            </div>
            <div class="stat-card success">
                <div class="stat-label">Successful</div>
                <div class="stat-value" id="statSuccess">-</div>
            </div>
            <div class="stat-card failed">
                <div class="stat-label">Failed</div>
                <div class="stat-value" id="statFailed">-</div>
            </div>
            <div class="stat-card info">
                <div class="stat-label">Success Rate</div>
                <div class="stat-value" id="statRate">-</div>
            </div>
            <div class="stat-card warning">
                <div class="stat-label">Avg Duration</div>
                <div class="stat-value" id="statDuration">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Tokens Used</div>
                <div class="stat-value" id="statTokens">-</div>
            </div>
        </section>

        <!-- Filters -->
        <section class="filters-section">
            <div class="filters-row">
                <div class="filter-group">
                    <label class="filter-label">Status</label>
                    <select class="filter-select" id="filterStatus">
                        <option value="all">All Statuses</option>
                        <option value="success">Success</option>
                        <option value="failed">Failed</option>
                        <option value="running">Running</option>
                        <option value="timeout">Timeout</option>
                        <option value="rate_limited">Rate Limited</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Job Type</label>
                    <select class="filter-select" id="filterJobType">
                        <option value="">All Types</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Time Range</label>
                    <select class="filter-select" id="filterDays">
                        <option value="1">Last 24 Hours</option>
                        <option value="7" selected>Last 7 Days</option>
                        <option value="30">Last 30 Days</option>
                        <option value="90">Last 90 Days</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Sort By</label>
                    <select class="filter-select" id="filterSort">
                        <option value="started_at">Start Time</option>
                        <option value="duration_seconds">Duration</option>
                        <option value="job_type">Job Type</option>
                    </select>
                </div>
                <div class="filter-group" style="flex: 0 0 auto;">
                    <button class="btn-filter" id="btnApplyFilters">Apply Filters</button>
                </div>
                <div class="filter-group" style="flex: 0 0 auto;">
                    <button class="btn-refresh" id="btnRefresh">üîÑ Refresh</button>
                </div>
            </div>
        </section>

        <!-- Logs Table -->
        <section class="logs-table-container">
            <table class="logs-table">
                <thead>
                    <tr>
                        <th>Job ID</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Started</th>
                        <th>Duration</th>
                        <th>Retries</th>
                        <th>Triggered By</th>
                        <th>Error</th>
                    </tr>
                </thead>
                <tbody id="logsTableBody">
                    <!-- Logs will be inserted here -->
                </tbody>
            </table>

            <!-- Empty State -->
            <div class="empty-state" id="emptyState" style="display: none;">
                <div class="icon">üì≠</div>
                <p>No job logs found matching your filters</p>
            </div>

            <!-- Pagination -->
            <div class="pagination" id="paginationContainer">
                <div class="pagination-info" id="paginationInfo">
                    Showing 0 of 0 jobs
                </div>
                <div class="pagination-controls" id="paginationControls">
                    <!-- Pagination buttons will be inserted here -->
                </div>
            </div>
        </section>
    </main>

    <!-- Job Detail Modal -->
    <div class="modal-overlay" id="jobDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Job Details</h2>
                <button class="modal-close" id="modalClose">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Detail content will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <script>
        // API Configuration
        const API_BASE = '/api/v1/job-logs';

        // State
        let currentPage = 1;
        let totalPages = 1;
        let currentFilters = {
            status: 'all',
            jobType: '',
            days: 7,
            sortBy: 'started_at'
        };

        // DOM Elements
        const logsTableBody = document.getElementById('logsTableBody');
        const emptyState = document.getElementById('emptyState');
        const paginationInfo = document.getElementById('paginationInfo');
        const paginationControls = document.getElementById('paginationControls');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const jobDetailModal = document.getElementById('jobDetailModal');
        const modalBody = document.getElementById('modalBody');

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadJobTypes();
            loadLogs();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('btnApplyFilters').addEventListener('click', () => {
                currentPage = 1;
                updateFilters();
                loadLogs();
            });

            document.getElementById('btnRefresh').addEventListener('click', () => {
                loadStats();
                loadLogs();
            });

            document.getElementById('modalClose').addEventListener('click', closeModal);
            document.getElementById('jobDetailModal').addEventListener('click', (e) => {
                if (e.target === jobDetailModal) closeModal();
            });

            // Keyboard shortcut for closing modal
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeModal();
            });
        }

        function updateFilters() {
            currentFilters = {
                status: document.getElementById('filterStatus').value,
                jobType: document.getElementById('filterJobType').value,
                days: parseInt(document.getElementById('filterDays').value),
                sortBy: document.getElementById('filterSort').value
            };
        }

        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/stats?days=${currentFilters.days}`, {
                    credentials: 'include'
                });

                if (response.status === 401) {
                    window.location.href = 'index.html';
                    return;
                }

                if (!response.ok) throw new Error('Failed to load stats');

                const data = await response.json();

                document.getElementById('statTotal').textContent = data.total_jobs.toLocaleString();
                document.getElementById('statSuccess').textContent = data.successful.toLocaleString();
                document.getElementById('statFailed').textContent = data.failed.toLocaleString();
                document.getElementById('statRate').textContent = `${data.success_rate}%`;
                document.getElementById('statDuration').textContent = `${data.avg_duration_seconds}s`;
                document.getElementById('statTokens').textContent = data.total_tokens_used.toLocaleString();

            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadJobTypes() {
            try {
                const response = await fetch(`${API_BASE}/types/list`, {
                    credentials: 'include'
                });

                if (!response.ok) return;

                const data = await response.json();
                const select = document.getElementById('filterJobType');

                data.job_types.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    select.appendChild(option);
                });

            } catch (error) {
                console.error('Error loading job types:', error);
            }
        }

        async function loadLogs() {
            showLoading(true);

            try {
                const params = new URLSearchParams({
                    page: currentPage,
                    page_size: 20,
                    days: currentFilters.days,
                    sort_by: currentFilters.sortBy,
                    sort_desc: true
                });

                if (currentFilters.status !== 'all') {
                    params.append('filter_status', currentFilters.status);
                }
                if (currentFilters.jobType) {
                    params.append('job_type', currentFilters.jobType);
                }

                const response = await fetch(`${API_BASE}/?${params}`, {
                    credentials: 'include'
                });

                if (response.status === 401) {
                    window.location.href = 'index.html';
                    return;
                }

                if (!response.ok) throw new Error('Failed to load logs');

                const data = await response.json();

                renderLogs(data.items);
                updatePagination(data);

            } catch (error) {
                console.error('Error loading logs:', error);
                logsTableBody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; color: #f87171;">
                            Failed to load logs: ${error.message}
                        </td>
                    </tr>
                `;
            } finally {
                showLoading(false);
            }
        }

        function renderLogs(logs) {
            if (!logs || logs.length === 0) {
                logsTableBody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            logsTableBody.innerHTML = logs.map(log => `
                <tr onclick="showJobDetail('${log.job_id}')">
                    <td>
                        <code style="color: #a78bfa; background: rgba(139, 92, 246, 0.1); padding: 2px 8px; border-radius: 4px;">
                            ${log.job_id}
                        </code>
                    </td>
                    <td>
                        <span class="job-type-badge">${log.job_type}</span>
                    </td>
                    <td>
                        <span class="status-badge status-${log.status}">${log.status}</span>
                    </td>
                    <td>${formatDateTime(log.started_at)}</td>
                    <td class="duration-cell">
                        ${log.duration_seconds ? formatDuration(log.duration_seconds) : '-'}
                    </td>
                    <td>${log.retry_count}</td>
                    <td>${log.triggered_by}</td>
                    <td>
                        ${log.error_message ?
                    `<span class="error-indicator" title="${escapeHtml(log.error_message)}">‚ö†Ô∏è</span>` :
                    '-'
                }
                    </td>
                </tr>
            `).join('');
        }

        function updatePagination(data) {
            totalPages = data.total_pages;
            const start = (data.page - 1) * data.page_size + 1;
            const end = Math.min(data.page * data.page_size, data.total);

            paginationInfo.textContent = `Showing ${start}-${end} of ${data.total} jobs`;

            let paginationHtml = `
                <button class="page-btn" onclick="goToPage(1)" ${data.page === 1 ? 'disabled' : ''}>¬´</button>
                <button class="page-btn" onclick="goToPage(${data.page - 1})" ${data.page === 1 ? 'disabled' : ''}>‚Äπ</button>
            `;

            // Show page numbers
            const maxVisible = 5;
            let startPage = Math.max(1, data.page - Math.floor(maxVisible / 2));
            let endPage = Math.min(totalPages, startPage + maxVisible - 1);

            if (endPage - startPage < maxVisible - 1) {
                startPage = Math.max(1, endPage - maxVisible + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                paginationHtml += `
                    <button class="page-btn ${i === data.page ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>
                `;
            }

            paginationHtml += `
                <button class="page-btn" onclick="goToPage(${data.page + 1})" ${data.page >= totalPages ? 'disabled' : ''}>‚Ä∫</button>
                <button class="page-btn" onclick="goToPage(${totalPages})" ${data.page >= totalPages ? 'disabled' : ''}>¬ª</button>
            `;

            paginationControls.innerHTML = paginationHtml;
        }

        function goToPage(page) {
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            loadLogs();
        }

        async function showJobDetail(jobId) {
            showLoading(true);

            try {
                const response = await fetch(`${API_BASE}/${jobId}`, {
                    credentials: 'include'
                });

                if (!response.ok) throw new Error('Failed to load job details');

                const job = await response.json();
                renderJobDetail(job);
                jobDetailModal.classList.add('show');

            } catch (error) {
                console.error('Error loading job detail:', error);
                alert('Failed to load job details');
            } finally {
                showLoading(false);
            }
        }

        function renderJobDetail(job) {
            modalBody.innerHTML = `
                <!-- Basic Info -->
                <div class="detail-section">
                    <h3 class="detail-section-title">Basic Information</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Job ID</div>
                            <div class="detail-value">${job.job_id}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Job Type</div>
                            <div class="detail-value"><span class="job-type-badge">${job.job_type}</span></div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Status</div>
                            <div class="detail-value"><span class="status-badge status-${job.status}">${job.status}</span></div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Triggered By</div>
                            <div class="detail-value">${job.triggered_by}</div>
                        </div>
                    </div>
                </div>

                <!-- Timing -->
                <div class="detail-section">
                    <h3 class="detail-section-title">Timing</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Started At</div>
                            <div class="detail-value">${formatDateTime(job.started_at)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Completed At</div>
                            <div class="detail-value">${job.completed_at ? formatDateTime(job.completed_at) : '-'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Duration</div>
                            <div class="detail-value">${job.duration_seconds ? formatDuration(job.duration_seconds) : '-'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Retry Count</div>
                            <div class="detail-value">${job.retry_count}</div>
                        </div>
                    </div>
                </div>

                <!-- Resource Usage -->
                <div class="detail-section">
                    <h3 class="detail-section-title">Resource Usage</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Tokens Used</div>
                            <div class="detail-value">${job.tokens_used ? job.tokens_used.toLocaleString() : '-'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">API Calls</div>
                            <div class="detail-value">${job.api_calls ? job.api_calls.toLocaleString() : '-'}</div>
                        </div>
                        ${job.parent_job_id ? `
                        <div class="detail-item">
                            <div class="detail-label">Parent Job</div>
                            <div class="detail-value">${job.parent_job_id}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>

                <!-- Input Snapshot -->
                ${job.input_snapshot ? `
                <div class="detail-section">
                    <h3 class="detail-section-title">Input Snapshot</h3>
                    <div class="code-block">
                        <pre>${JSON.stringify(job.input_snapshot, null, 2)}</pre>
                    </div>
                </div>
                ` : ''}

                <!-- Output Snapshot -->
                ${job.output_snapshot ? `
                <div class="detail-section">
                    <h3 class="detail-section-title">Output Snapshot</h3>
                    <div class="code-block">
                        <pre>${JSON.stringify(job.output_snapshot, null, 2)}</pre>
                    </div>
                </div>
                ` : ''}

                <!-- Error Details -->
                ${job.error_message ? `
                <div class="detail-section">
                    <h3 class="detail-section-title">Error Details</h3>
                    <div class="error-block">
                        <pre>${escapeHtml(job.error_message)}</pre>
                    </div>
                    ${job.error_traceback ? `
                    <h4 class="detail-section-title" style="margin-top: 16px;">Stack Trace</h4>
                    <div class="error-block">
                        <pre>${escapeHtml(job.error_traceback)}</pre>
                    </div>
                    ` : ''}
                </div>
                ` : ''}
            `;
        }

        function closeModal() {
            jobDetailModal.classList.remove('show');
        }

        function showLoading(show) {
            loadingOverlay.classList.toggle('show', show);
        }

        function formatDateTime(isoString) {
            if (!isoString) return '-';
            const date = new Date(isoString);
            return date.toLocaleString();
        }

        function formatDuration(seconds) {
            if (seconds < 1) return `${Math.round(seconds * 1000)}ms`;
            if (seconds < 60) return `${seconds.toFixed(2)}s`;
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${minutes}m ${secs.toFixed(0)}s`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>

</html>